{% extends "explorer/base.html" %}
{% load static %}

{% block content %}

<h1 class="text-center mb-4">‚≠ê Meus Favoritos</h1>

<!-- =========================
     TOPO: VOLTAR + BUSCA + LIMPAR
========================= -->
<div class="d-flex justify-content-center gap-2 flex-wrap mb-3">

    <a href="{% url 'apod_view' %}" class="btn btn-outline-light">
        ‚¨Ö Voltar ao APOD
    </a>

    <form method="get" class="d-flex gap-2">

        <input
            type="text"
            name="q"
            placeholder="üîé Buscar por t√≠tulo..."
            value="{{ query|default:'' }}"
            class="form-control"
        >

        <button class="btn btn-primary">Buscar</button>

        <a href="{% url 'favorites_list' %}" class="btn btn-secondary">
            Limpar
        </a>

    </form>
</div>


{% if favorites %}

<!-- ‚úÖ CONTADOR -->
<p id="fav-counter" class="text-center small text-info mb-3">
    ‚≠ê {{ favorites.paginator.count }} favorito(s)
    {% if query %} para "{{ query }}"{% endif %}
</p>


<div class="row g-4" id="favorites-grid">

    {% for fav in favorites %}
    <div class="col-12 col-md-6 col-lg-4 fav-item">

        <div class="card space-card text-light h-100 p-3 text-center">

            <a href="{{ fav.url }}" target="_blank">
                <img src="{{ fav.url }}" class="img-fluid rounded mb-3">
            </a>

            <h6>{{ fav.title }}</h6>
            <small>üìÖ {{ fav.date }}</small>

            <form action="{% url 'remove_favorite' fav.id %}" method="post" class="mt-3 remove-form">
                {% csrf_token %}
                <button class="btn btn-danger w-100">
                    ‚ùå Remover
                </button>
            </form>

        </div>

    </div>
    {% endfor %}

</div>


<!-- =========================
     PAGINA√á√ÉO
========================= -->
{% if favorites.has_other_pages %}
<div class="d-flex justify-content-center mt-4 gap-2 flex-wrap">

    {% if favorites.has_previous %}
        <a href="?page={{ favorites.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-outline-light">
            ‚¨Ö Anterior
        </a>
    {% endif %}

    <span class="btn btn-light disabled">
        P√°gina {{ favorites.number }} de {{ favorites.paginator.num_pages }}
    </span>

    {% if favorites.has_next %}
        <a href="?page={{ favorites.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-outline-light">
            Pr√≥xima ‚û°
        </a>
    {% endif %}

</div>
{% endif %}


{% else %}

<div class="text-center mt-5">
    <h4>Nenhum favorito ainda üòÖ</h4>
    <p>Favorite algumas imagens primeiro!</p>
</div>

{% endif %}

{% endblock %}


{% block scripts %}
<script>
// =========================
// AJAX remover + atualizar contador
// =========================
document.querySelectorAll(".remove-form").forEach(form => {
    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            }
        }).then(() => {

            // remove card
            const card = form.closest(".fav-item");
            card.remove();

            // atualiza contador
            const counter = document.getElementById("fav-counter");
            const total = document.querySelectorAll(".fav-item").length;

            counter.innerText = `‚≠ê ${total} favorito(s)`;
        });
    });
});
</script>
{% endblock %}