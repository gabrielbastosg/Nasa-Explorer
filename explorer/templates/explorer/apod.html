{% extends "explorer/base.html" %}
{% load static %}

{% block content %}

<h1 class="text-center mb-4">
    ‚ú¶ Foto Astron√¥mica do Dia
</h1>

<!-- ESTAT√çSTICAS -->
<div class="text-center mb-4">
    <p>üìú Visitados: <strong>{{ total_history }}</strong></p>
    <p>‚≠ê Favoritos: <strong>{{ total_favorites }}</strong></p>
</div>

<div class="card text-light p-4 mx-auto space-card" style="max-width: 900px;">

    <!-- FORM DATA -->
    <form method="get" class="text-center mb-4">
        <input
            type="date"
            name="date"
            value="{{ date_input_format }}"
            class="form-control w-auto d-inline"
        >
        <button class="btn btn-primary ms-2">
            Ver foto
        </button>
    </form>

    {% if error %}
        <p class="text-danger text-center">{{ error }}</p>
    {% else %}

        <h3 class="text-center">{{ title }}</h3>
        <p class="text-center">üìÖ {{ date }}</p>

        <!-- NAVEGA√á√ÉO -->
        <div class="d-flex justify-content-center gap-2 mb-3">
            <a href="?date={{ prev_date }}" class="btn btn-outline-light">‚¨Ö</a>
            <a href="{% url 'apod_view' %}" class="btn btn-outline-light">Hoje</a>
            <a href="?date={{ next_date }}" class="btn btn-outline-light">‚û°</a>
            <button id="random-btn" class="btn btn-outline-light">üé≤ Aleat√≥ria</button>
        </div>

        <!-- IMAGEM -->
        <img
            src="{{ image_url }}"
            class="img-fluid rounded shadow mb-3 d-block mx-auto"
        >

        <!-- A√á√ïES -->
        <div class="text-center mb-3">

            <!-- DOWNLOAD -->
            <a href="{{ image_url }}" download="{{ download_name }}" class="btn btn-success">
                ‚¨á Baixar
            </a>

            <!-- FAVORITO -->
            <form action="{% url 'add_favorite' %}" method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="title" value="{{ title }}">
                <input type="hidden" name="url" value="{{ image_url }}">
                <button class="btn btn-warning">
                    ‚≠ê Favoritar
                </button>
            </form>

            <!-- CURTIDAS -->
            {% if history %}
            <button id="like-btn" class="btn btn-primary">
                üëç Curtir (<span id="like-count">{{ history.likes }}</span>)
            </button>
            {% endif %}

        </div>

        <p class="mt-3 text-start">
            {{ explanation }}
        </p>

    {% endif %}

</div>

{% endblock %}


{% block scripts %}
<script>
// --- CURTIDAS ---
const likeBtn = document.getElementById("like-btn");
const likeCount = document.getElementById("like-count");

if(likeBtn){
    likeBtn.addEventListener("click", () => {
        likeBtn.disabled = true;
        fetch("{% url 'like_apod' history.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(res => res.json())
        .then(data => {
            likeCount.innerText = data.likes;
            likeBtn.innerText = "üëç Curtido";
        })
        .catch(() => {
            likeBtn.disabled = false;
        });
    });
}

// --- BOT√ÉO ALEAT√ìRIO COM FADE ---
const randomBtn = document.getElementById("random-btn");
const imgEl = document.querySelector("img.img-fluid");
const titleEl = document.querySelector("h3.text-center");
const dateEl = document.querySelector("p.text-center");

function fadeOutIn(el, newSrc, newTitle, newDate){
    el.style.transition = "opacity 0.5s";
    el.style.opacity = 0;

    setTimeout(() => {
        el.src = newSrc;
        titleEl.innerText = newTitle;
        dateEl.innerText = "üìÖ " + newDate;
        el.onload = () => {
            el.style.opacity = 1;
        }
    }, 500);
}

if(randomBtn){
    randomBtn.addEventListener("click", (e) => {
        e.preventDefault();
        randomBtn.disabled = true;

        fetch("{% url 'random_apod' %}?ajax=1")
        .then(res => res.json())
        .then(data => {
            if(data.error){
                alert("Erro ao carregar APOD!");
                randomBtn.disabled = false;
                return;
            }
            fadeOutIn(imgEl, data.image_url, data.title, data.date);
            randomBtn.disabled = false;
        })
        .catch(() => {
            alert("Erro ao carregar APOD!");
            randomBtn.disabled = false;
        });
    });
}
</script>
{% endblock %}